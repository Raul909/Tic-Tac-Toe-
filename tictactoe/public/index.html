<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Tic Tac Toe - Mission Control</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
  <script src="/socket.io/socket.io.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            space: '#000510',
            nasa: '#00d4ff',
            mars: '#ff6b35',
            earth: '#4dffdb'
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Exo+2:wght@300;400;600;700&family=Space+Mono&display=swap');
    body { font-family: 'Space Mono', monospace; }
    h1, h2, h3 { font-family: 'Exo 2', sans-serif; }
  </style>
</head>
<body class="bg-space text-white min-h-screen" x-data="app()" x-init="init()">
  
  <!-- Auth Screen -->
  <div x-show="screen === 'auth'" class="min-h-screen flex items-center justify-center p-4">
    <div class="max-w-md w-full">
      <div class="text-center mb-8">
        <div class="text-nasa text-sm tracking-widest mb-2">‚óÜ MISSION CONTROL ‚óÜ</div>
        <h1 class="text-4xl font-bold tracking-wider">TIC TAC TOE</h1>
        <p class="text-gray-400 text-sm mt-2">Tactical Grid Combat</p>
      </div>
      
      <div class="bg-gray-900/50 backdrop-blur border border-nasa/30 rounded-lg p-6">
        <!-- Tabs -->
        <div class="flex gap-2 mb-6">
          <button @click="authTab = 'login'" 
                  :class="authTab === 'login' ? 'bg-nasa text-black' : 'bg-gray-800 text-white'"
                  class="flex-1 py-2 px-4 rounded font-semibold transition">
            SIGN IN
          </button>
          <button @click="authTab = 'register'" 
                  :class="authTab === 'register' ? 'bg-nasa text-black' : 'bg-gray-800 text-white'"
                  class="flex-1 py-2 px-4 rounded font-semibold transition">
            REGISTER
          </button>
        </div>
        
        <!-- Login Form -->
        <form x-show="authTab === 'login'" @submit.prevent="login()" class="space-y-4">
          <div>
            <label class="block text-xs text-nasa mb-1 tracking-wider">CALLSIGN</label>
            <input x-model="loginForm.username" type="text" 
                   class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 focus:border-nasa focus:outline-none"
                   placeholder="Enter callsign">
          </div>
          <div>
            <label class="block text-xs text-nasa mb-1 tracking-wider">ACCESS CODE</label>
            <input x-model="loginForm.password" type="password" 
                   class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 focus:border-nasa focus:outline-none"
                   placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
          </div>
          <div x-show="loginError" x-text="loginError" class="text-mars text-sm"></div>
          <button type="submit" :disabled="loginLoading"
                  class="w-full bg-nasa text-black font-bold py-3 rounded hover:bg-nasa/90 transition disabled:opacity-50">
            <span x-show="!loginLoading">INITIATE LOGIN ‚Üí</span>
            <span x-show="loginLoading">AUTHENTICATING...</span>
          </button>
        </form>
        
        <!-- Register Form -->
        <form x-show="authTab === 'register'" @submit.prevent="register()" class="space-y-4">
          <div>
            <label class="block text-xs text-nasa mb-1 tracking-wider">CALLSIGN <span class="text-gray-500">(3-16 chars)</span></label>
            <input x-model="registerForm.username" type="text" 
                   class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 focus:border-nasa focus:outline-none"
                   placeholder="Choose callsign">
          </div>
          <div>
            <label class="block text-xs text-nasa mb-1 tracking-wider">ACCESS CODE <span class="text-gray-500">(min 8 chars)</span></label>
            <input x-model="registerForm.password" type="password" 
                   class="w-full bg-gray-800 border border-gray-700 rounded px-4 py-2 focus:border-nasa focus:outline-none"
                   placeholder="Set access code">
          </div>
          <div x-show="registerError" x-text="registerError" class="text-mars text-sm"></div>
          <button type="submit" :disabled="registerLoading"
                  class="w-full bg-nasa text-black font-bold py-3 rounded hover:bg-nasa/90 transition disabled:opacity-50">
            <span x-show="!registerLoading">REGISTER OPERATOR ‚Üí</span>
            <span x-show="registerLoading">CREATING...</span>
          </button>
        </form>
      </div>
    </div>
  </div>
  
  <!-- Lobby Screen -->
  <div x-show="screen === 'lobby'" class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <div class="flex justify-between items-center mb-6">
        <div>
          <div class="text-nasa text-xs tracking-widest">‚óÜ MISSION CONTROL ‚óÜ</div>
          <div class="text-2xl font-bold" x-text="user.username"></div>
        </div>
        <button @click="logout()" class="bg-gray-800 px-4 py-2 rounded hover:bg-gray-700">LOGOUT</button>
      </div>
      
      <div class="flex gap-4 mb-6">
        <div class="bg-gray-900/50 border border-nasa/30 rounded px-4 py-2">
          <span class="text-nasa text-xs">W-</span><span x-text="user.stats.wins">0</span>
        </div>
        <div class="bg-gray-900/50 border border-nasa/30 rounded px-4 py-2">
          <span class="text-nasa text-xs">D-</span><span x-text="user.stats.draws">0</span>
        </div>
        <div class="bg-gray-900/50 border border-nasa/30 rounded px-4 py-2">
          <span class="text-nasa text-xs">L-</span><span x-text="user.stats.losses">0</span>
        </div>
      </div>
      
      <div class="bg-gray-900/50 backdrop-blur border border-nasa/30 rounded-lg p-6 space-y-6">
        <div>
          <h3 class="text-nasa text-sm tracking-wider mb-4">üöÄ MULTIPLAYER MISSION</h3>
          <div class="flex gap-4">
            <button @click="createRoom()" class="flex-1 bg-nasa text-black font-bold py-4 rounded hover:bg-nasa/90">
              + LAUNCH ROOM
            </button>
            <div class="flex-1 flex gap-2">
              <input x-model="joinCode" type="text" maxlength="4" placeholder="CODE"
                     class="flex-1 bg-gray-800 border border-gray-700 rounded px-4 uppercase text-center focus:border-nasa focus:outline-none">
              <button @click="joinRoom()" class="bg-gray-800 px-6 rounded hover:bg-gray-700">DOCK ‚Üí</button>
            </div>
          </div>
          <div x-show="lobbyError" x-text="lobbyError" class="text-mars text-sm mt-2"></div>
        </div>
        
        <div>
          <h3 class="text-nasa text-sm tracking-wider mb-4">ü§ñ TRAINING MODE</h3>
          <button @click="startAI()" class="w-full bg-mars text-white font-bold py-4 rounded hover:bg-mars/90">
            ENGAGE AI
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Waiting Screen -->
  <div x-show="screen === 'waiting'" class="min-h-screen flex items-center justify-center p-4">
    <div class="text-center">
      <div class="text-2xl mb-4">Waiting for opponent...</div>
      <div class="text-6xl font-bold text-nasa mb-2" x-text="roomCode"></div>
      <div class="text-gray-400 mb-6">Share this code</div>
      <button @click="copyRoomCode()" class="bg-gray-800 px-6 py-2 rounded hover:bg-gray-700">üìã COPY CODE</button>
      <button @click="cancelWaiting()" class="block mx-auto mt-4 text-gray-400 hover:text-white">‚Üê Back</button>
    </div>
  </div>
  
  <!-- Game Screen -->
  <div x-show="screen === 'game'" class="min-h-screen p-4">
    <div class="max-w-4xl mx-auto">
      <div class="text-center mb-6">
        <div class="text-nasa text-xs tracking-widest mb-2" x-text="gameStatus"></div>
        <div class="flex justify-center gap-8 text-sm">
          <div><span class="text-mars">X:</span> <span x-text="scores.X">0</span></div>
          <div><span class="text-gray-500">D:</span> <span x-text="scores.D">0</span></div>
          <div><span class="text-earth">O:</span> <span x-text="scores.O">0</span></div>
        </div>
      </div>
      
      <div class="grid grid-cols-3 gap-2 max-w-md mx-auto mb-6">
        <template x-for="(cell, i) in board" :key="i">
          <button @click="makeMove(i)" 
                  :disabled="!canMove(i)"
                  class="aspect-square bg-gray-900/50 border border-nasa/30 rounded-lg text-6xl font-bold hover:bg-gray-800/50 disabled:cursor-not-allowed transition"
                  :class="cell === 'X' ? 'text-mars' : cell === 'O' ? 'text-earth' : ''"
                  x-text="cell || ''">
          </button>
        </template>
      </div>
      
      <div class="text-center">
        <button @click="leaveGame()" class="bg-gray-800 px-6 py-2 rounded hover:bg-gray-700">‚Üê ABORT</button>
      </div>
    </div>
  </div>
  
  <!-- Game Over Modal -->
  <div x-show="gameOver" class="fixed inset-0 bg-black/80 flex items-center justify-center p-4 z-50">
    <div class="bg-gray-900 border-2 border-nasa rounded-lg p-8 text-center max-w-md">
      <div class="text-6xl mb-4" x-text="gameOverEmoji"></div>
      <div class="text-3xl font-bold mb-2" x-text="gameOverTitle"></div>
      <div class="text-nasa text-sm mb-6" x-text="gameOverSubtitle"></div>
      <div class="flex gap-4">
        <button @click="rematch()" class="flex-1 bg-nasa text-black font-bold py-3 rounded hover:bg-nasa/90">
          RE-ENGAGE
        </button>
        <button @click="leaveGame()" class="flex-1 bg-gray-800 py-3 rounded hover:bg-gray-700">
          ABORT
        </button>
      </div>
    </div>
  </div>

  <script>
    function app() {
      return {
        screen: 'auth',
        authTab: 'login',
        socket: null,
        user: { username: '', stats: { wins: 0, draws: 0, losses: 0 } },
        
        // Auth
        loginForm: { username: '', password: '' },
        registerForm: { username: '', password: '' },
        loginError: '',
        registerError: '',
        loginLoading: false,
        registerLoading: false,
        
        // Lobby
        joinCode: '',
        lobbyError: '',
        
        // Game
        roomCode: '',
        mySymbol: '',
        board: Array(9).fill(null),
        currentTurn: 'X',
        gameActive: false,
        scores: { X: 0, O: 0, D: 0 },
        gameStatus: '',
        gameOver: false,
        gameOverTitle: '',
        gameOverSubtitle: '',
        gameOverEmoji: '',
        mode: '',
        
        init() {
          const token = localStorage.getItem('token');
          if (token) {
            this.connectSocket(token);
          }
        },
        
        connectSocket(token) {
          this.socket = io({ autoConnect: true, reconnectionAttempts: 5, withCredentials: true });
          
          this.socket.on('connect', () => {
            this.socket.emit('auth', { token });
          });
          
          this.socket.on('auth:ok', (data) => {
            this.user = { username: data.username, stats: data.stats };
            this.screen = 'lobby';
          });
          
          this.socket.on('auth:error', () => {
            localStorage.removeItem('token');
            this.screen = 'auth';
          });
          
          this.socket.on('room:created', ({ code, symbol }) => {
            this.roomCode = code;
            this.mySymbol = symbol;
            this.screen = 'waiting';
          });
          
          this.socket.on('room:error', (msg) => {
            this.lobbyError = msg;
            setTimeout(() => this.lobbyError = '', 3000);
          });
          
          this.socket.on('game:start', (data) => {
            this.board = data.board;
            this.currentTurn = data.currentTurn;
            this.scores = data.scores;
            this.gameActive = true;
            this.mode = 'online';
            this.screen = 'game';
            this.updateGameStatus();
          });
          
          this.socket.on('game:move', ({ index, symbol }) => {
            this.board[index] = symbol;
          });
          
          this.socket.on('game:turn', ({ currentTurn }) => {
            this.currentTurn = currentTurn;
            this.updateGameStatus();
          });
          
          this.socket.on('game:over', ({ winner, draw, scores }) => {
            this.scores = scores;
            this.gameActive = false;
            this.showGameOver(winner, draw);
          });
        },
        
        async login() {
          this.loginError = '';
          if (!this.loginForm.username || !this.loginForm.password) {
            this.loginError = 'Please fill all fields';
            return;
          }
          
          this.loginLoading = true;
          try {
            const res = await fetch('/api/login', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(this.loginForm)
            });
            const data = await res.json();
            
            if (data.ok) {
              localStorage.setItem('token', data.token);
              this.user = { username: data.username, stats: data.stats };
              this.connectSocket(data.token);
            } else {
              this.loginError = data.error;
            }
          } catch (e) {
            this.loginError = 'Connection error';
          }
          this.loginLoading = false;
        },
        
        async register() {
          this.registerError = '';
          if (!this.registerForm.username || !this.registerForm.password) {
            this.registerError = 'Please fill all fields';
            return;
          }
          
          this.registerLoading = true;
          try {
            const res = await fetch('/api/register', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              credentials: 'include',
              body: JSON.stringify(this.registerForm)
            });
            const data = await res.json();
            
            if (data.ok) {
              localStorage.setItem('token', data.token);
              this.user = { username: data.username, stats: data.stats };
              this.connectSocket(data.token);
            } else {
              this.registerError = data.error;
            }
          } catch (e) {
            this.registerError = 'Connection error';
          }
          this.registerLoading = false;
        },
        
        logout() {
          localStorage.removeItem('token');
          if (this.socket) this.socket.disconnect();
          this.screen = 'auth';
          this.user = { username: '', stats: { wins: 0, draws: 0, losses: 0 } };
        },
        
        createRoom() {
          this.lobbyError = '';
          this.socket.emit('room:create');
        },
        
        joinRoom() {
          const code = this.joinCode.trim().toUpperCase();
          if (code.length !== 4) {
            this.lobbyError = 'Code must be 4 characters';
            return;
          }
          this.lobbyError = '';
          this.socket.emit('room:join', { code });
        },
        
        cancelWaiting() {
          if (this.roomCode) {
            this.socket.emit('room:leave', { code: this.roomCode });
          }
          this.screen = 'lobby';
        },
        
        copyRoomCode() {
          navigator.clipboard.writeText(this.roomCode);
        },
        
        startAI() {
          this.mode = 'ai';
          this.mySymbol = 'X';
          this.board = Array(9).fill(null);
          this.currentTurn = 'X';
          this.gameActive = true;
          this.scores = { X: 0, O: 0, D: 0 };
          this.screen = 'game';
          this.updateGameStatus();
        },
        
        canMove(index) {
          return this.gameActive && !this.board[index] && 
                 (this.mode === 'ai' ? this.currentTurn === 'X' : this.currentTurn === this.mySymbol);
        },
        
        makeMove(index) {
          if (!this.canMove(index)) return;
          
          if (this.mode === 'ai') {
            this.board[index] = 'X';
            if (this.checkWin('X')) {
              this.scores.X++;
              this.showGameOver('X', false);
              return;
            }
            if (this.board.every(c => c)) {
              this.scores.D++;
              this.showGameOver(null, true);
              return;
            }
            this.currentTurn = 'O';
            setTimeout(() => this.aiMove(), 500);
          } else {
            this.socket.emit('game:move', { code: this.roomCode, index });
          }
        },
        
        aiMove() {
          const move = this.getBestMove();
          if (move !== -1) {
            this.board[move] = 'O';
            if (this.checkWin('O')) {
              this.scores.O++;
              this.showGameOver('O', false);
              return;
            }
            if (this.board.every(c => c)) {
              this.scores.D++;
              this.showGameOver(null, true);
              return;
            }
            this.currentTurn = 'X';
          }
        },
        
        getBestMove() {
          for (let i = 0; i < 9; i++) {
            if (!this.board[i]) return i;
          }
          return -1;
        },
        
        checkWin(player) {
          const wins = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
          return wins.some(line => line.every(i => this.board[i] === player));
        },
        
        updateGameStatus() {
          if (this.mode === 'ai') {
            this.gameStatus = this.currentTurn === 'X' ? 'YOUR TURN' : 'AI THINKING...';
          } else {
            this.gameStatus = this.currentTurn === this.mySymbol ? 'YOUR TURN' : 'OPPONENT TURN';
          }
        },
        
        showGameOver(winner, draw) {
          this.gameActive = false;
          this.gameOver = true;
          
          if (draw) {
            this.gameOverEmoji = 'ü§ù';
            this.gameOverTitle = 'STANDOFF';
            this.gameOverSubtitle = 'MISSION DRAW';
          } else if (winner === this.mySymbol || (this.mode === 'ai' && winner === 'X')) {
            this.gameOverEmoji = 'üèÜ';
            this.gameOverTitle = 'MISSION COMPLETE';
            this.gameOverSubtitle = 'VICTORY ACHIEVED';
          } else {
            this.gameOverEmoji = '‚ùå';
            this.gameOverTitle = 'MISSION FAILED';
            this.gameOverSubtitle = this.mode === 'ai' ? 'AI VICTORY' : 'DEFEAT';
          }
        },
        
        rematch() {
          this.gameOver = false;
          if (this.mode === 'ai') {
            this.board = Array(9).fill(null);
            this.currentTurn = 'X';
            this.gameActive = true;
            this.updateGameStatus();
          } else {
            this.socket.emit('game:rematch', { code: this.roomCode });
          }
        },
        
        leaveGame() {
          this.gameOver = false;
          if (this.mode === 'online' && this.roomCode) {
            this.socket.emit('room:leave', { code: this.roomCode });
          }
          this.screen = 'lobby';
          this.board = Array(9).fill(null);
          this.gameActive = false;
        }
      }
    }
  </script>
</body>
</html>
